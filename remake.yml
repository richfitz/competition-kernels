packages:
  - tree2

sources:
  - R

plot_options:
  tall:
    height: 8
    width: 5.5

targets:
  all:
    depends:
      - tree_data
      - figures
      - ms/competition-kernels.pdf
  # NOTE: some issues getting dependencies to behave sensibly here
  # (manuscript rebuilding when figures change but tex does not)
  figures:
    depends:
      # - glob("ms/figures/*")
      - ms/figures/kernel.pdf
      - ms/figures/components.pdf
      - ms/figures/rstar.pdf
      - ms/figures/tree_hmat.pdf
      - ms/figures/tree_lma.pdf

  figures_sm:
    depends:
      - ms/figures/sm_rstar_components1.pdf
      - ms/figures/sm_rstar_components2.pdf
      - ms/figures/sm_tree_lma_components.pdf
      - ms/figures/sm_tree_hmat_components.pdf

  tree_data:
    depends:
      - tree_lma_1
      - tree_lma_2
      - tree_hmat_1
      - tree_hmat_2

  ms/competition-kernels.pdf:
    depends:
      - ms/references.bib
      - ms/ms.sty
      - ms/amnat.bst
    command: build_pdf("ms/competition-kernels.tex")

  # Data common to all _resident_ communities, but specific to one set
  # of parameter values.
  #
  # I'm pretty tempted to make these check: exists, because they are a
  # total hassle to regenerate and I don't think we should be doing
  # that lightly.
  tree_lma_shared:
    command: tree_competition_prepare(I("lma"), parallel=TRUE)
    quiet: false
  tree_hmat_shared:
    command: tree_competition_prepare(I("hmat"), parallel=TRUE)
    quiet: false

  tree_lma_1:
    command: tree_competition(0.2, tree_lma_shared)
  tree_lma_2:
    command: tree_competition(0.11, tree_lma_shared)
  tree_hmat_1:
    command: tree_competition(5.0, tree_hmat_shared)
  tree_hmat_2:
    command: tree_competition(17.0, tree_hmat_shared)

  ms/figures/kernel.pdf:
    command: fig_kernel()
    plot: true
  ms/figures/components.pdf:
    command: fig_components()
    plot: true
  ms/figures/rstar.pdf:
    command: fig_rstar()
    plot:
      height: 6
      width: 8
  ms/figures/tree_hmat.pdf:
    command: fig_tree_hmat(tree_hmat_1, tree_hmat_2)
    plot: true
  ms/figures/tree_lma.pdf:
    command: fig_tree_lma(tree_lma_1, tree_lma_2)
    plot: true

  ms/figures/sm_rstar_components1.pdf:
    command: fig_rstar_components(1)
    plot: tall
  ms/figures/sm_rstar_components2.pdf:
    command: fig_rstar_components(2)
    plot: tall
  ms/figures/sm_tree_lma_components.pdf:
    command: fig_tree_components(tree_lma_1, tree_lma_2)
    plot: tall
  ms/figures/sm_tree_hmat_components.pdf:
    command: fig_tree_components(tree_hmat_1, tree_hmat_2)
    plot: tall

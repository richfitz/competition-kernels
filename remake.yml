packages:
  - plant
  - rootSolve
  - rmarkdown
  - BB
  - nleqslv
  - numDeriv
  - deSolve
  - callr

sources:
  - R

plot_options:
  tall:
    height: 6.5
    width: 5.5
  wide:
    height: 3.5
    width: 5.5
    pointsize: 10
  skinny:
    height: 4.5
    width: 3
    pointsize: 10
  square:
    height: 5.5
    width: 5.5
  shape:
    height: 1.3
    width: 2

knitr_options:
  vignette:
    auto_figure_prefix: true
    chdir: true

targets:
  all:
    depends:
      - plant_data
      - figures
      - figures_sm
      - ms/competition-kernels.pdf
      - ms/competition-kernels-sm.pdf
      - vignettes/comp_lotka_tilman.pdf

  # NOTE: some issues getting dependencies to behave sensibly here
  # (manuscript rebuilding when figures change but tex does not)
  figures:
    depends:
      # - glob("ms/figures/*")
      - ms/figures/kernel.pdf
      - ms/figures/components.pdf
      - ms/figures/rstar.pdf
      - ms/figures/plant_hmat.pdf
      - ms/figures/plant_lma.pdf
      - ms/figures/plant_lma_density.pdf
      - figures_shapes

  figures_sm:
    depends:
      - ms/figures/sm_rstar_components1.pdf
      - ms/figures/sm_rstar_components2.pdf
      - ms/figures/sm_rstar_abrams.pdf
      - ms/figures/sm_rstar_density1.pdf
      - ms/figures/sm_rstar_density2.pdf
      - ms/figures/sm_plant_lma_components.pdf
      - ms/figures/sm_plant_hmat_components.pdf
      - ms/figures/sm_plant_hmat_density.pdf

  figures_shapes:
    depends:
      - ms/figures/shape/constant.pdf
      - ms/figures/shape/gaussian.pdf
      - ms/figures/shape/platykurtic.pdf
      - ms/figures/shape/logistic.pdf
      - ms/figures/shape/gaussian_offset.pdf
      - ms/figures/shape/exponential.pdf
      - ms/figures/shape/bessel.pdf
      - ms/figures/shape/laplacian.pdf
      - ms/figures/shape/gaussian_with_hat.pdf
      - ms/figures/shape/step_asymmetric.pdf

  plant_data:
    depends:
      - plant_lma_1
      - plant_lma_2
      - plant_hmat_1
      - plant_hmat_2

  plant_density_data:
    depends:
      - plant_lma_density_1
      - plant_lma_density_2
      - plant_hmat_density_1
      - plant_hmat_density_2

  ms/competition-kernels.pdf:
    depends:
      - ms/competition-kernels-sm.pdf
      - ms/ms.sty
      - ms/amnat.bst
      - ms/shapes.tex
      - figures
      - figures_shapes
    command: latex_build("ms/competition-kernels.tex", "ms/references.bib", clean=TRUE)

  ms/competition-kernels-sm.pdf:
    depends:
      - ms/suppmat.sty
      - figures_sm
    # NOTE: clean is FALSE here because we need the '.aux' file for above.
    command: latex_build("ms/competition-kernels-sm.tex", clean=FALSE)

  # Data common to all _resident_ communities, but specific to one set
  # of parameter values.
  #
  # I'm pretty tempted to make these check: exists, because they are a
  # total hassle to regenerate and I don't think we should be doing
  # that lightly.
  plant_lma_shared:
    command: plant_competition_prepare(I("lma"), parallel=TRUE)
    quiet: false
  plant_hmat_shared:
    command: plant_competition_prepare(I("hmat"), parallel=TRUE)
    quiet: false

  plant_lma_1:
    command: plant_competition(0.17, plant_lma_shared)
  plant_lma_2:
    command: plant_competition(0.07, plant_lma_shared)
  plant_hmat_1:
    command: plant_competition(5.0, plant_hmat_shared)
  plant_hmat_2:
    command: plant_competition(15.5, plant_hmat_shared)

  plant_lma_density_1:
    command: plant_competition_density(plant_lma_1)
  plant_lma_density_2:
    command: plant_competition_density(plant_lma_2)
  plant_hmat_density_1:
    command: plant_competition_density(plant_hmat_1)
  plant_hmat_density_2:
    command: plant_competition_density(plant_hmat_2)

  ms/figures/kernel.pdf:
    command: fig_kernel()
    plot: wide
  ms/figures/components.pdf:
    command: fig_components()
    plot: tall
  ms/figures/rstar.pdf:
    command: fig_rstar()
    plot: wide
  ms/figures/plant_hmat.pdf:
    command: fig_plant(plant_hmat_1, plant_hmat_2)
    plot: skinny
  ms/figures/plant_lma.pdf:
    command: fig_plant(plant_lma_1, plant_lma_2)
    plot: skinny
  ms/figures/plant_lma_density.pdf:
    command: fig_plant_density(plant_lma_density_1, plant_lma_density_2)
    plot: wide

  ms/figures/sm_rstar_components1.pdf:
    command: fig_rstar_components(1)
    plot: tall
  ms/figures/sm_rstar_components2.pdf:
    command: fig_rstar_components(2)
    plot: tall
  ms/figures/sm_plant_lma_components.pdf:
    command: fig_plant_components(plant_lma_1, plant_lma_2)
    plot: tall
  ms/figures/sm_plant_hmat_components.pdf:
    command: fig_plant_components(plant_hmat_1, plant_hmat_2)
    plot: tall
  ms/figures/sm_plant_hmat_density.pdf:
    command: fig_plant_density(plant_hmat_density_1, plant_hmat_density_2)
    plot: wide

  ms/figures/shape/constant.pdf:
    command: shape_constant()
    plot: shape
  ms/figures/shape/gaussian.pdf:
    command: shape_gaussian()
    plot: shape
  ms/figures/shape/platykurtic.pdf:
    command: shape_platykurtic()
    plot: shape
  ms/figures/shape/logistic.pdf:
    command: shape_logistic()
    plot: shape
  ms/figures/shape/gaussian_offset.pdf:
    command: shape_gaussian_offset()
    plot: shape
  ms/figures/shape/exponential.pdf:
    command: shape_exponential()
    plot: shape
  ms/figures/shape/bessel.pdf:
    command: shape_bessel()
    plot: shape
  ms/figures/shape/laplacian.pdf:
    command: shape_laplacian()
    plot: shape
  ms/figures/shape/gaussian_with_hat.pdf:
    command: shape_gaussian_with_hat()
    plot: shape
  ms/figures/shape/step_asymmetric.pdf:
    command: shape_step_asymmetric()
    plot: shape

  dat_rstar_abrams:
    command: rstar_add_abrams()
  ms/figures/sm_rstar_abrams.pdf:
    command: fig_rstar_abrams(dat_rstar_abrams)
    plot: true
  ms/figures/sm_rstar_density1.pdf:
    command: fig_rstar_density(1)
    plot: true
  ms/figures/sm_rstar_density2.pdf:
    command: fig_rstar_density(2)
    plot: true

  vignettes/comp_lotka_tilman.md:
    knitr: vignette
  vignettes/comp_lotka_tilman.pdf:
    command: render_pdf("vignettes/comp_lotka_tilman.md")
